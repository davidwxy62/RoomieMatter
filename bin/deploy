#!/bin/bash
# Stop on errors
set -Eeuo pipefail
# Sanity check command line options
usage() {
    echo "Usage: $0 [--react] [--flask] [--manager]"
}
if [ $# -gt 3 ]; then
    echo "Error: too many arguments"
    usage
    exit 1
fi

for arg in "$@"; do
    if [ $arg != "--react" ] && [ $arg != "--flask" ] && [ $arg != "--manager" ]; then
        echo "Error: invalid argument"
        usage
        exit 1
    fi
done

for arg in "$@"; do
    case $arg in
        --react)
            npx webpack
            echo "React app built"
            ;;
        --flask)
            pkill -f gunicorn
            gunicorn -b localhost:8000 -w 2 -D roomieMatter:app
            echo "Flask server started"
            ;;
        --manager)
            pkill -f particleManager.py || true
            rm -rf var/log/particleManager.log || true
            mkdir var/log || true
            sudo python3 particleManager/particleManager.py --host 0.0.0.0 --port 1002 --logfile var/log/particleManager.log & sleep 2
            echo "Particle manager started"
            ;;
    esac
done